{% extends '_default/list.html.twig' %}

{% block content %}
    <main class="d-flex flex-column flex-grow-1">
        <div class="container my-5">
            <header class="mb-5 text-center">
                <h1 class="display-5 fw-bold">{{ page.title }}</h1>
                {% if page.content %}
                    <p class="lead text-muted">{{ page.content }}</p>
                {% endif %}
            </header>

            <!-- Filtres par tags -->
            {% set all_tags = [] %}
            {% for p in pages %}
                {% if p.tags %}
                    {% set all_tags = all_tags|merge(p.tags) %}
                {% endif %}
            {% endfor %}

            {% set unique_tags = [] %}
            {% for tag in all_tags %}
                {% if tag not in unique_tags %}
                    {% set unique_tags = unique_tags|merge([tag]) %}
                {% endif %}
            {% endfor %}
            {% set unique_tags = unique_tags|sort %}

            {% if unique_tags %}
                <div class="mb-4 text-center">
                    <span class="badge bg-secondary me-2 mb-2 filter-badge active" data-filter="all"
                          style="cursor: pointer;">Tous</span>
                    {% for tag in unique_tags %}
                        <span class="badge bg-secondary me-2 mb-2 filter-badge" data-filter="{{ tag|lower }}"
                              style="cursor: pointer;">{{ tag }}</span>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="row g-4" id="blog-posts">
                {% for p in pages %}
                    <div class="col-md-6 col-lg-4 blog-post-item"
                         data-tags="{% if p.tags %}{{ p.tags|join(' ')|lower }}{% endif %}">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body d-flex flex-column">
                                <h2 class="card-title fs-4 mb-2">
                                    <a href="{{ url(p) }}" class="text-decoration-none">
                                        {{ p.title|e }}
                                    </a>
                                </h2>
                                <time class="text-muted small mb-3">
                                    {{ p.date|format_date('long') }}
                                </time>
                                {% if p.tags %}
                                    <div class="mb-3">
                                        {% for tag in p.tags %}
                                            <a href="{{ url('tags/' ~ tag) }}"
                                               class="badge bg-secondary text-decoration-none me-1 mb-1">{{ tag }}</a>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <p class="card-text">
                                    {{ p.content|excerpt_html }}
                                </p>
                                <a href="{{ url(p) }}" class="btn btn-outline-light mt-auto text-decoration-none">
                                    Read more
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <footer class="mt-5">
                {{ include('partials/paginator.html.twig', {page}, with_context = false) }}
            </footer>
        </div>

        <script>
            // Filtrage par tags
            document.addEventListener('DOMContentLoaded', function () {
                const filterBadges = document.querySelectorAll('.filter-badge');
                const blogPosts = document.querySelectorAll('.blog-post-item');

                filterBadges.forEach(badge => {
                    badge.addEventListener('click', function () {
                        const filter = this.getAttribute('data-filter');

                        // Mise Ã  jour des badges actifs
                        filterBadges.forEach(b => {
                            b.classList.remove('active', 'bg-primary');
                            b.classList.add('bg-secondary');
                        });
                        this.classList.remove('bg-secondary');
                        this.classList.add('active', 'bg-primary');

                        // Filtrage des articles
                        blogPosts.forEach(post => {
                            const tags = post.getAttribute('data-tags');
                            if (filter === 'all' || tags.includes(filter)) {
                                post.style.display = 'block';
                            } else {
                                post.style.display = 'none';
                            }
                        });
                    });
                });
            });
        </script>
    </main>
{% endblock content %}
